<?php

/**
* @file
* Attempts to ingest a specimen object and delete it.
*
* @author Dalton Mackenzie <demackenzie@upei.ca>
*/

class IslandoraSpecimenIngestTestCase extends IslandoraWebTestCase {

  /**
  * Get test information
  *
  * @see IslandoraWebTestCase::getInfo()
  */

  public static function getInfo() {
   
    $message = "Testing getInfo().\n";
    file_put_contents("/tmp/test.txt", $message, FILE_APPEND | LOCK_EX);

    return array(
      'name' => 'Specimen Ingest/Deletion',
      'description' => 'Ingests a specimen and then deletes it.',
      'group' => 'Islandora Specimen',
    );
  }

  /**
  * Set up the test environment.
  *
  * @see IslandoraWebTestCase::setUp()
  */

  public function setUp() {

    $message = "Testing setUp().\n";
    file_put_contents("/tmp/test.txt", $message, FILE_APPEND | LOCK_EX);

  parent::setUp(array(
      'islandora',
      'islandora_lab_object_specimen',
      'islandora_basic_collection',
      )
    );
  }

  /**
  * Creates an administrative user and attempts to ingest a project
  */

                                                  

  public function testIngestSpecimen() {
 
  $user = $this->admin;

    //Creates an admin user

    
/*
    $user = $this->drupalCreateUser(array(
      'view fedora repository objects',
      'ingest fedora objects',
      'administer site configuration',
      'manage object properties',
      'delete fedora objects and datastreams',
      'create child collection',
    ));
*/
    //Logs them in.
   
    $message = "About to create the user.\n";
    file_put_contents("/tmp/test.txt", $message, FILE_APPEND | LOCK_EX);

    //$user = $this->createAdminUser();

    $this->drupalLogin($user);

    $message = "Got the user logged in.\n";
    file_put_contents("/tmp/test.txt", $message, FILE_APPEND | LOCK_EX);

    //Create a specimen properties array for the construction and ingestion of a specimen object.
    $specimen_properties = array();   //init the array
    $specimen_properties['label'] = 'specimen_test';   //Give it a label
    $specimen_properties['pid'] = 'islandora:test_specimen';  //PID
    $specimen_properties['models'] = array(   //The content model used is the specimen_cmodel
        'islandora:specimen_cmodel',
        );
    $specimen_properties['parent'] = 'islandora:root'; //Just use root as the parent for now, delete it at the end of the test.

    $specimen_datastreams = array(); // init the data streams array


    //The datastreams for the object will be taken from files in the fixtures directory
    
    $specimen_datastream_dc = array(); //Init the Dublin Core datastream
    $specimen_datastream_dc['dsid'] = 'DC';  //dsid comes from the ds composite model in the xml directory
    $specimen_datastream_dc['path'] = 'fixtures/example_specimen_dc.xml'; //Path to the file containing the datastream
    $specimen_datastream_dc['control_group'] = 'M'; //M - managed by Fedora, X - in line XML
    $specimen_datastream_dc['mimetype'] = 'text/xml';

    $specimen_datastream_mads = array(); //Init the MADS datastream
    $specimen_datastream_mads['dsid'] = 'EML'; //dsid comes from the ds composite model in the xml directory
    $specimen_datastream_mads['path'] = 'fixtures/example_specimen_eml.xml'; //Path to the file containing the datastream
    $specimen_datastream_mads['control_group'] = 'M'; //M - managed by Fedora, X - in line XML
    $specimen_datastream_mads['mimetype'] = 'text/xml';

    $specimen_datastream_relsext = array(); //Init the RELS-EXT datastream
    $specimen_datastream_relsext['dsid'] = 'RELS-EXT'; //dsid comes from the ds composite model in the xml directory
    $specimen_datastream_relsext['path'] = 'fixtures/example_specimen_relsext.rdf'; //Path to the file containing the datastream
    $specimen_datastream_relsext['control_group'] = 'M'; //M - managed by Fedora, X - in line XML
    $specimen_datastream_relsext['mimetype'] = 'text/xml';

    //Add all of the datastreams to the datastreams array

    $specimen_datastreams[] = $specimen_datastream_dc;
    $specimen_datastreams[] = $specimen_datastream_mads;
    $specimen_datastreams[] = $specimen_datastream_relsext;

    //Ingest the object with its properties array and datastreams array.
    

    $message = "About to attempt ingesting the object.\n";
    file_put_contents("/tmp/test.txt", $message, FILE_APPEND | LOCK_EX);

    try {
      $specimen_test_object = $this->ingestConstructedObject($specimen_properties, $specimen_datastreams);
    }
    catch (RepositoryException $re)
    {
      echo 'Caught exception: ',  $re->getMessage(), "\n";
    }

    $message = "Ingested the constructed object.\n";
    file_put_contents("/tmp/test.txt", $message, FILE_APPEND | LOCK_EX);

    //$this->deleteObject('islandora:test_specimen', $button = NULL, $safety = TRUE);

  }
}
